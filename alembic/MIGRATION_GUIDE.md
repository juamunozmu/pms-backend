# ğŸ¯ Crear Primera MigraciÃ³n con Alembic

## ğŸ“ Contexto

Ya tenemos:
- âœ… Alembic configurado (`alembic.ini`, `env.py`, `script.py.mako`)
- âœ… Todos los modelos SQLAlchemy creados (19 tablas)
- âœ… Modelos importados en `models/__init__.py`

Ahora crearemos la migraciÃ³n inicial que generarÃ¡ el esquema de la base de datos.

---

## ğŸš€ Paso 1: Generar la MigraciÃ³n AutomÃ¡ticamente

Como no tenemos Alembic instalado localmente (solo estÃ¡ en `requirements.txt`), usaremos Docker para ejecutar el comando.

### **OpciÃ³n A: Ejecutar en el contenedor de backend (cuando estÃ© corriendo)**

```bash
# Cuando tengas el backend corriendo con docker compose
docker compose exec backend alembic revision --autogenerate -m "initial schema with all 19 tables"
```

### **OpciÃ³n B: Ejecutar en un contenedor temporal de Python**

```bash
# Crear un contenedor temporal con Python y las dependencias
docker run --rm -it \
  -v "e:/University/projects/pms/pms-backend:/app" \
  -w /app \
  --network pms_network \
  python:3.12-slim \
  bash -c "pip install -r requirements.txt && alembic revision --autogenerate -m 'initial schema with all 19 tables'"
```

**ExplicaciÃ³n del comando:**
- `docker run --rm`: Crea un contenedor temporal que se elimina al terminar
- `-it`: Modo interactivo con terminal
- `-v "e:/University/projects/pms/pms-backend:/app"`: Monta tu carpeta local en `/app` del contenedor
- `-w /app`: Define `/app` como directorio de trabajo
- `--network pms_network`: Conecta al mismo network que PostgreSQL
- `python:3.12-slim`: Imagen de Python 3.12
- `bash -c "..."`: Ejecuta comandos dentro del contenedor

---

## ğŸ“‹ Paso 2: Revisar la MigraciÃ³n Generada

Alembic crearÃ¡ un archivo en `alembic/versions/` con un nombre como:

```
a1b2c3d4e5f6_initial_schema_with_all_19_tables.py
```

Abre ese archivo y verÃ¡s algo como:

```python
"""initial schema with all 19 tables

Revision ID: a1b2c3d4e5f6
Revises: 
Create Date: 2024-01-15 10:30:00

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = 'a1b2c3d4e5f6'
down_revision = None
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('global_admins',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(100), nullable=False),
        sa.Column('password_hash', sa.String(255), nullable=False),
        # ... mÃ¡s columnas ...
        sa.PrimaryKeyConstraint('id')
    )
    
    op.create_table('rates',
        sa.Column('id', sa.Integer(), nullable=False),
        # ...
    )
    
    # ... mÃ¡s tablas ...
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('rates')
    op.drop_table('global_admins')
    # ... orden inverso ...
    # ### end Alembic commands ###
```

**Â¿QuÃ© revsar?**
- âœ… Que todas las 19 tablas estÃ©n presentes
- âœ… Que los foreign keys estÃ©n correctos
- âœ… Que los Ã­ndices se hayan creado
- âœ… Que los constraints (CheckConstraint) estÃ©n ahÃ­

---

## âš¡ Paso 3: Aplicar la MigraciÃ³n

Una vez revisada, aplicamos la migraciÃ³n a la base de datos:

```bash
# OpciÃ³n A: Con backend corriendo
docker compose exec backend alembic upgrade head

# OpciÃ³n B: Con contenedor temporal
docker run --rm -it \
  -v "e:/University/projects/pms/pms-backend:/app" \
  -w /app \
  --network pms_network \
  python:3.12-slim \
  bash -c "pip install -r requirements.txt && alembic upgrade head"
```

VerÃ¡s un output como:

```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> a1b2c3d4e5f6, initial schema with all 19 tables
```

---

## ğŸ” Paso 4: Verificar en la Base de Datos

Verifica que las tablas se crearon correctamente:

```bash
# Conectarse a PostgreSQL
docker compose exec postgres psql -U pms_user -d pms_db

# Ver todas las tablas
\dt

# Ver estructura de una tabla especÃ­fica
\d global_admins

# Ver tabla de versiones de Alembic (tracking de migraciones)
SELECT * FROM alembic_version;
```

**DeberÃ­as ver:**
- Las 19 tablas creadas
- Una tabla `alembic_version` con el revision ID de tu migraciÃ³n

---

## ğŸ”„ Paso 5: Probar el Rollback (Opcional)

Para verificar que la migraciÃ³n es reversible:

```bash
# Revertir la migraciÃ³n
alembic downgrade -1

# Verificar que las tablas se eliminaron
docker compose exec postgres psql -U pms_user -d pms_db -c "\dt"

# Volver a aplicar
alembic upgrade head
```

---

## ğŸ“Œ Resumen de Comandos Ãštiles

```bash
# Ver estado actual
alembic current

# Ver historial de migraciones
alembic history

# Ver migraciones pendientes
alembic show head

# Aplicar todas las migraciones
alembic upgrade head

# Revertir Ãºltima migraciÃ³n
alembic downgrade -1

# Revertir todas las migraciones (âš ï¸ CUIDADO)
alembic downgrade base

# Ver SQL sin aplicar cambios
alembic upgrade head --sql
```

---

## ğŸ“ PrÃ³ximos Pasos

DespuÃ©s de crear la primera migraciÃ³n:

1. **Configurar el backend** para usar los modelos SQLAlchemy
2. **Crear repositorios** (adaptadores) que implementen las interfaces del dominio
3. **Implementar casos de uso** para las historias de usuario
4. **Crear endpoints de API** para interactuar con el sistema

---

## âš ï¸ Notas Importantes

### **Diferencia con el `create_tables.sql` actual**

Actualmente tenemos un script SQL que crea las tablas directamente. Con Alembic:
- âœ… Tenemos control de versiones
- âœ… Podemos hacer rollback
- âœ… Podemos modificar esquemas incrementalmente
- âœ… Todos los desarrolladores tienen el mismo esquema

### **Convivencia (Temporal)**

Por ahora, ambos existen:
- **`create_tables.sql`**: Para setup rÃ¡pido en Docker
- **Alembic migrations**: Para desarrollo con control de versiones

**RecomendaciÃ³n:** Una vez que Alembic funcione correctamente, eliminar `create_tables.sql` y usar solo Alembic.

---

Â¿Listo para crear la migraciÃ³n? ğŸš€
